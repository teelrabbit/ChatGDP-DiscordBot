on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # ... (checkout, install AWS CLI, configure AWS credentials, etc)

    - name: Package code into .zip file
      run: |
        zip -r ChatGDP-DiscordBot.zip .

    - name: Upload code to S3
      uses: shallwefootball/s3-upload-action@master
      with:
        args: --no-progress
        aws_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws_bucket: elasticbeanstalk-us-west-1-431738351778
        source_dir: .
        destination_dir: .

    - name: Create application version
      run: |
        aws elasticbeanstalk create-application-version \
          --application-name ChatGDP-DiscordBot \
          --version-label "$(git rev-parse HEAD)" \
          --source-bundle S3Bucket=elasticbeanstalk-us-west-1-431738351778,S3Key=ChatGDP-DiscordBot.zip

    - name: Check if this is a pull request
      if: github.event_name == 'pull_request'
      run: echo "Deploying to test environment"

    - name: Deploy application version (test)
      if: github.event_name == 'pull_request'
      run: |
        aws elasticbeanstalk update-environment \
          --environment-name Chatgdpdiscordbot-test-env \
          --version-label "$(git rev-parse HEAD)"

    - name: Deploy application version (prod)
      if: github.event_name == 'push'
      run: |
        aws elasticbeanstalk update-environment \
          --environment-name Chatgdpdiscordbot-env-1 \
          --version-label "$(git rev-parse HEAD)"

    - name: Start Bot
      run: |
        node index.js
